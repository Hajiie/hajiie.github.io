---
title: 투수 동작 분석 서버 및 시각화
published: 2025-12-29
description: 'Django-based Pitcher Analysis Backend Server & Visualization'
image: "./INGPS_Skeleton.png"
tags: [Python, Server, Django]
category: 'Django'
draft: false 
lang: 'Python'
---
::github{repo="Hajiie/IN_GPS_SERVER"}

# 투수 동작 분석 서버

## 배경

- 인하대학교의 연구실 TACTICS로부터 요청을 받아 영상 업로드, 투구 분석 기능을 RESTful API로 제공하여, 클라이언트 애플리케이션에서 투수의 데이터를 관리하고 분석 결과를 활용할 수 있는 서버를 제작

## 주요 기술 및 구현
Backend Framework
- Django를 사용하여 데이터 모델링(ORM), API 엔드포이늩 처리, 파일 업로드 및 관리를 수행

Pose Estimation(자세 추정)
- MediaPipe Pose를 활용하여 투수의 신체 33개 랜드마크를 추출. 이를 통해 관절의 위치, 각도, 움직임을 프레임 단위로 추적

Obect Detection(객체 탐지)
- YOLO(Ultralytics) 모델(`best_baseball_ball.pt`)을 사용하여 투구된 공을 프레임별로 탐지하고 추적

Video Processing
- **OpenCV(cv2)** 를 사용하여 비디오 프레임 추출, 이미지 전처리, 그리고 분석 결과(스켈레톤, 궤적 등)가 시각화된 결과 영상을 렌더링

Data Analysis Algorithms
- FastDTW(Dynamic Time Warping): 시계열 데이터의 유사도를 분석하는 알고리즘으로, 투구 속도가 다르더라도 기준 영상(Optimum Form)과 테스트 영상 간의 자세 유사도를 구간별로 비교 및 채점
- BioMechanics Calculation: `numpy`를 활용하여 관절 각도(팔꿈치, 무릎), 상체 기울기, 손목 속도, 어깨 회적 각속도 등을 수학적으로 계싼

## 시스템 주요 기능
자동 투구 구간 분할(Phrase Segmentation)
- 투구 동작을 **Start(시작) -> Max Knee(키킹 정점) -> Fixed(착지) -> Release(릴리스) -> Follow(팔로우스로)** 의 4단계로 자동 분할하여 분석

정밀 투구 분석
- 릴리스 이후 공의 위치를 추적, 선수의 정강이 길이(Shin Length)를 기준으로 픽셀 거리를 실제 거리로 변환하여 구속(km/h)을 계산
- 릴리스 순간의 팔 각도, 무릎 각도, 상체 기울기, 손의 높이 등을 수치화하여 제공
- 손목의 이동 속도(m/s)와 어깨의 회전 각속도(deg/s)를 그래프 및 히트맵 형태의 영상으로 시각화

유사도 분석(DTW Similiarity)
- 선수의 '최적 폼(Optimum Form)' 영상과 현재 투구 영상을 비교하여, 전체적인 유사도 점수와 각 투구 구간별(키킹, 스트라이드 등) 유사도를 100점 만점으로 평가

시각화 영상 생성
- 분석된 데이터를 바탕으로 스켈레톤(뼈대), 팔 스윙 궤적, 공의 궤적 등이 오버레이된 영상을 자동으로 생성하여 시각적 피드백을 제공

선수 및 시즌 관리
- 선수 프로필, 시즌별 상세 스텟(ERA, 승/패, 탈삼진 등)을 체계적으로 관리하는 CRUD 기능을 제공

## 프로젝트 의의
저비용 고효율 분석
- 고가의 모션 캡처 장비 없이 일반 카메라 영상만으로 투구 폼을 정밀하게 분석할 수 있는 솔루션

데이터 기반 코칭
- 육안으로 확인하기 힘든 관절 각도나 순간 속도 등을 수치화하여, 감에 의존하던 코칭을 데이터 기반의 과학적 코칭으로 전환

객관적 비교 분석
- DTW 알고리즘을 통해 이상적인 폼과 현재 폼의 차이를 객관적인 점수로 보여주어 교정 훈련의 효율 상승

---

# 투수 동작 분석 서버 트러블슈팅 정리

## 1. 분석 영상 구간 설정 오류
문제 및 원인
- 투구 분석 시, 실제 투구 동작 구간(`start frame` ~ `follow frame`)만 분석해야 하는데 영상 전체 구간을 분석하는 현상 발생.
- 개발 및 테스트 과정에서 편의를 위해 분석 범위를 전체 영상으로 임시 수정해두었던 코드가 배포 버전에 그대로 잔재

해결 방법
- 분석 로직에서 프레임 범위를 다시 `start frame` ~ `follow frame` 까지로 제한하도록 코드를 복구하여, 불필요한 구간이 분석 결과에 포함되지 않도록 수정함

## 2. 시각화 영상 렌더링 오류
문제 및 원인
- 팔 스윙 궤적, 어깨 회전 속도, 릴리스 포인트 등을 시각화한 결과 영상이 제대로 생성되지 않거나 그래픽이 어긋나게 표시됨
- 영상 위에 분석 데이터를 그리는 `render` 함수들의 좌표 계산 로직이나 그리기 순서 등에 결함

해결 방법
- `render_arm_swing_speed_video`, `render_shoulder_angular_velocity_video` 등의 함수 내부 로직을 전면 수정하여, 좌표 변환과 오버레이 처리가 정확하게 수행되도록 개선

## 3. 어깨 각속도 라벨 값 표시 오류
문제 및 원인
- 생성된 분석 영상에서 어깨 회전 각속도를 나타내는 라벨(수치)이 실제 계산된 값과 다르게 표시
- 시각화 과정에서 라벨에 값을 매핑하거나 출력하는 부분의 코드에 오타 및 잘못된 변수 참조

해결 방법
- 라벨 출력 로직을 검토, 올바른 각속도 변수가 매핑되도록 수정, 단위 및 표시 형식 수정

## 4. DTW 유사도 분석 로직 오류
문제 및 원인
- 투구 폼 유사도(DTW) 분석 결과 점수가 예상과 다르게 나오거나 부정확함
- DTW 알고리즘 구현부와 데이터를 전처리하여 알고리즘에 입력하는 과정에서 논리적 오류 존재

해결 방법
- DTW 유사도 계산 로직을 디버깅하여 오류를 수정, 영상 일시정지 기능 등과 연동될 때 필요한 FPS 처리 로직도 함께 보완하여 정확도를 높임

## 5. IDOR 보안 취약점
문제 및 원인
- 선수나 영상 등의 리소스 식별자로 예측 가능한 정수형 ID(1,2,3,...)를 사용하고 있어, 공격자가 ID를 조작하여 다른 사용자의 데이터에 접근할 수 있는 위험(IDOR)이 존재함
- 초기 개발 단계에서 데이터베이스의 기본 설정인 Auto Increment ID를 그대로 사용

해결 방법
- 모든 주요 모델(Player, VideoAnalysis 등)의 Primary Key를 예측 불가능한 UUID로 변경하고, API 엔드포인트에서도 UUID를 받도록 수정하여 보안성 강화